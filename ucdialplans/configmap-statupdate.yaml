apiVersion: v1
kind: ConfigMap
metadata:
  name: statupdate-script
  namespace: mariadb
  labels:
    app: ucdialplans
    argocd.argoproj.io/instance: ucdialplans
data:
  statupdate.sql: |
    UPDATE ucdialplans.InfoCache SET Value = CASE
        WHEN Attribute = 'TotalRegions' THEN 
      (SELECT SUM(UniqueRegions) FROM (SELECT COUNT(DISTINCT CONCAT(City, '-', StateProv)) AS UniqueRegions FROM ucdialplans.NANPA_Prefix
          UNION ALL
          SELECT COUNT(DISTINCT CONCAT(CountryID, '-', Region)) AS UniqueRegions FROM ucdialplans.AreaCodes
          UNION ALL
          SELECT COUNT(DISTINCT Region) AS UniqueRegions FROM ucdialplans.AreaCodes_NZ
      ) AS CombinedSubquery)
        WHEN Attribute = 'TotalUsers' THEN 
      (SELECT Count(*) FROM ucdialplans.Users)
        WHEN Attribute = 'TotalRulesets' THEN 
      (SELECT Count(*) FROM ucdialplans.Rulesets)
        WHEN Attribute = 'TotalExtensions' THEN 
      (SELECT Count(*) FROM ucdialplans.Extensions)
        ELSE Value
    END;

    TRUNCATE TABLE ucdialplans.InfoCache_Top10_Countries;
    INSERT INTO ucdialplans.InfoCache_Top10_Countries (Country, Rulesets)
    SELECT dr.CountryName AS Country, COUNT(*) AS Rulesets
    FROM ucdialplans.Rulesets rs
    JOIN DialRules dr ON rs.CountryID = dr.CountryID
    GROUP BY dr.CountryName
    ORDER BY Rulesets DESC
    LIMIT 10;

    TRUNCATE TABLE ucdialplans.InfoCache_Top10_Regions;
    INSERT INTO ucdialplans.InfoCache_Top10_Regions (City, CountryID, Frequency)
    SELECT City, CountryID, COUNT(*) AS Frequency
    FROM ucdialplans.Rulesets
    GROUP BY City, CountryID
    ORDER BY Frequency DESC
    LIMIT 10;