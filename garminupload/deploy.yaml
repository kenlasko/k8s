---
apiVersion: v1
kind: ConfigMap
metadata:
  name: garminupload-config
  namespace: garminupload
data:
  GCProgramSettings.xml: |
    <GCProgramSettings>
      <BaseURLs>
        <BaseLoginURL>https://sso.garmin.com/sso/signin</BaseLoginURL>
        <PostLoginURL>https://connect.garmin.com/modern/</PostLoginURL>
        <ActivitySearchURL>https://connect.garmin.com/modern/proxy/activitylist-service/activities/search/activities</ActivitySearchURL>
        <GPXActivityBaseURL>https://connect.garmin.com/modern/proxy/download-service/export/gpx/activity/</GPXActivityBaseURL>
        <TCXActivityBaseURL>https://connect.garmin.com/modern/proxy/download-service/export/tcx/activity/</TCXActivityBaseURL>
        <FITActivityBaseURL>https://connect.garmin.com/modern/proxy/download-service/files/activity/</FITActivityBaseURL>
      </BaseURLs>
    </GCProgramSettings>

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: garminupload-userdata
  namespace: garminupload
data:
  GCUserSettings.xml: |
    <!-- Garmin Connect Activity Export User Settings XML -->
    <GCUserSettings>
      <Credentials>
        <UserName>ken.lasko@gmail.com</UserName> <!-- Your Garmin Connect username -->
        <Password>***REMOVED***</Password> <!-- Your Garmin Connect password -->
      </Credentials>
      <ActivityFileType>FIT</ActivityFileType> <!-- FIT, GPX or TCX -->
      <DownloadOption>New</DownloadOption> <!-- New or All -->
      <Folders>
        <Destination>
          <Folder>/garmin-data</Folder> <!-- Destination folder, like c:\Garmin -->
          <Overwrite>Yes</Overwrite>
        </Destination>
      </Folders>
    </GCUserSettings>


---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: garmin-upload
  namespace: garmin-upload
spec:
  schedule: "@yearly" 
  suspend: true
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          nodeSelector:
            server-speed: nuc-slow
          restartPolicy: Never
          volumes:
          - name: garminupload-config
            configMap:
              name: garminupload-config
          - name: garminupload-userdata
            configMap:
              name: garminupload-userdata
          - name: garmindata
            persistentVolumeClaim:
              claimName: longhorn-garmin-pvc
          containers:
          - name: garmin-upload
            image: registry.ucdialplans.com/garminupload
            imagePullPolicy: IfNotPresent
            resources:
              requests:
                cpu: 100m
                memory: 300Mi
              limits:
                cpu: 300m
                memory: 300Mi
            env:
            - name: GarminLastActivity
              value: "10753075580"
            volumeMounts:
            - name: garmindata
              mountPath: /garmin-data
            - name: garminupload-config
              mountPath: "/garmin-data/GCProgramSettings.xml"
              subPath: "GCProgramSettings.xml"
            - name: garminupload-userdata
              mountPath: "/garmin-data/GCUserSettings.xml"
              subPath: "GCUserSettings.xml"

