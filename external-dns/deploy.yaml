---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
  namespace: external-dns
  annotations:
    keel.sh/policy: force
    keel.sh/match-tag: "true"
    keel.sh/trigger: poll
spec:
  replicas: 1
  revisionHistoryLimit: 2
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: external-dns
  template:
    metadata:
      labels:
        app: external-dns
    spec:
      restartPolicy: Always
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: DoesNotExist
              - key: kubernetes.io/arch
                operator: In
                values: 
                - 'amd64'
      serviceAccountName: external-dns
      containers:
      - name: external-dns
        image: registry.k8s.io/external-dns/external-dns:v0.14.0
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 100
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop: ["ALL"]
        resources:
          requests:
            cpu: 50m
            memory: 50Mi
          limits:
            cpu: 150m
            memory: 100Mi
        env:
        - name: TZ
          value: "America/Toronto"
        envFrom:
        - secretRef:
            name: pihole-creds
        args:
        - --source=service
        - --source=traefik-proxy
        - --registry=noop
        - --policy=upsert-only
        # - --provider=pihole
        # - --pihole-server=http://pihole-web.pihole.svc.cluster.local
        - --provider=webhook
        - --webhook-provider-url=http://localhost:8888     
      - name: adguardhome-provider
        image: ghcr.io/zekker6/external-dns-provider-adguard:v0.0.8
        resources:
          requests:
            cpu: 50m
            memory: 50Mi
          limits:
            cpu: 150m
            memory: 100Mi
        env:
        - name: ADGUARD_HOME_URL
          value: "http://adguard-web.adguard.svc.cluster.local:3000/control/" # Note: URL should be in the format of http://adguard.home:3000/control/
        - name: ADGUARD_HOME_PASS
          value: "***REMOVED***"
        - name: ADGUARD_HOME_USER
          value: "kenadmin"
      securityContext:
        fsGroup: 65534 # For ExternalDNS to be able to read Kubernetes token files