---
# Installs prerequisites for all K3S nodes
- hosts: k3s-workers
  become: true
  become_user: root
  tasks:
  - name: Install Longhorn prereq - NFS Common
    ansible.builtin.apt:
      name: nfs-common
      state: present
  - name: Install Longhorn prereq - Open-ISCSI
    ansible.builtin.apt:
      name: open-iscsi
      state: present
  - name: Install Longhorn prereq - Linux Utils
    ansible.builtin.apt:
      name: util-linux
      state: present
  - name: Create /kube-storage folder
    file:
      path: /kube-storage
      state: directory
  - name: Create /kube-storage/mariadb folder
    file:
      path: /kube-storage/mariadb
      state: directory
- hosts: k3s-servers
  become: true
  become_user: root
  tasks:
  - name: Install registry prereq - Apache2 Utils
    ansible.builtin.apt:
      name: apache2-utils
      state: present
- hosts: k3s-all
  become: true
  become_user: root
  tasks:      
  - name: Add KUBECONFIG environment variable to all hosts
    ansible.builtin.lineinfile:
      path: /etc/environment
      line: KUBECONFIG=/etc/rancher/k3s/k3s.yaml
  - name: Set timezone
    community.general.timezone:
      name: America/Toronto
  - name: Disable swap
    ansible.builtin.shell: swapoff -a
  - name: Disable SWAP in fstab
    replace:
      path: /etc/fstab
      regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
      replace: '# \1'
  - name: Set kernel parameters - VM Panic on OOM
    ansible.posix.sysctl:
      name: vm.panic_on_oom
      value: '0'
      sysctl_file: /etc/sysctl.d/90-kubelet.conf
      state: present
  - name: Set kernel parameters - mem overcommit
    ansible.posix.sysctl:
      name: vm.overcommit_memory
      value: '1'
      sysctl_file: /etc/sysctl.d/90-kubelet.conf
      state: present
  - name: Set kernel parameters - Kernel panic
    ansible.posix.sysctl:
      name: kernel.panic
      value: '10'
      sysctl_file: /etc/sysctl.d/90-kubelet.conf
      state: present
  - name: Set kernel parameters - Kernel panic on oops
    ansible.posix.sysctl:
      name: kernel.panic_on_oops
      value: '1'
      sysctl_file: /etc/sysctl.d/90-kubelet.conf
      state: present