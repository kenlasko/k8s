---
# Installs the base apps (Cilium, Traefik, ArgoCD) to get started with installing all other apps
- hosts: workstation
  tasks:
  - name: ensures .kube dir exists
    file: 
      path: "/home/ken/.kube"
      state: directory
  - name: Copy k3s.yaml to ~/.kube/config
    shell: scp ken@nuc1:/etc/rancher/k3s/k3s.yaml ~/.kube/config && chmod 0600 ~/.kube/config && sed -i 's/127.0.0.1/192.168.1.4/g' ~/.kube/config
  - name: Add node labels for longhorn
    shell: kubectl label nodes nuc4 nuc5 nuc6 storage=longhorn
  - name: Add node labels for GPU
    shell: kubectl label nodes nuc4 nuc5 nuc6 intel.feature.node.kubernetes.io/gpu=true
  - name: Install default sealed secrets certificate
    kubernetes.core.k8s:
      state: present
      verify_ssl: no
      src: /home/ken/default-sealing-key.yaml
  - name: Install original sealed secrets certificate
    kubernetes.core.k8s:
      state: present
      verify_ssl: no
      src: /home/ken/global-sealed-secrets-key.yaml
  - name: Add Cilium chart repo
    kubernetes.core.helm_repository:
      name: cilium
      repo_url: "https://helm.cilium.io/"
  - name: Apply Gateway API CRDs
    kubernetes.core.k8s:
      state: present
      src: /home/ken/k3s/cilium/gateway-api-crds.yaml  
  - name: Deploy Cilium
    environment:
      KUBECONFIG: /home/ken/.kube/config
    kubernetes.core.helm:
      name: cilium
      chart_ref: cilium/cilium
      chart_version: "1.15.3"
      release_namespace: cilium
      create_namespace: true
      update_repo_cache: true
      values_files:
      - /home/ken/k3s/cilium/values.yaml
  - name: Add Sealed-Secrets chart repo
    kubernetes.core.helm_repository:
      name: bitnami-labs
      repo_url: "https://bitnami-labs.github.io/sealed-secrets/"
  - name: Deploy Sealed Secrets
    kubernetes.core.helm:
      name: sealed-secrets
      chart_ref: bitnami-labs/sealed-secrets
      create_namespace: false
      release_namespace: kube-system
      verify_ssl: no
      values_files:
      - /home/ken/k3s/sealed-secrets/values.yaml
  - name: Add Cert-Manager chart repo
    kubernetes.core.helm_repository:
      name: cert-manager
      repo_url: "https://charts.jetstack.io"
      force_update: true
  - name: Deploy Cert-Manager
    kubernetes.core.helm:
      name: cert-manager
      chart_ref: cert-manager/cert-manager
      create_namespace: true
      release_namespace: cert-manager
      values_files:
      - /home/ken/k3s/cert-manager/values.yaml
  - name: Apply Cert-Manager resources
    kubernetes.core.k8s:
      definition: "{{ lookup('template', '{{ item }}') | from_yaml }}"
    with_fileglob:
    - "/home/ken/k3s/cert-manager/cloudflare-cert.yaml"
    - "/home/ken/k3s/cert-manager/sealed-secrets.yaml"
  - name: Add ArgoCD chart repo
    kubernetes.core.helm_repository:
      name: argocd
      repo_url: "https://argoproj.github.io/argo-helm"
  - name: Deploy ArgoCD
    kubernetes.core.helm:
      name: argocd
      chart_ref: argocd/argo-cd
      create_namespace: true
      release_namespace: argocd
      values_files:
      - /home/ken/k3s/argocd/values.yaml
  # - name: Apply ArgoCD secrets
  #   kubernetes.core.k8s:
  #     state: present
  #     src: /home/ken/k3s/argocd/01-sealed-secrets.yaml
  - name: Apply ArgoCD K8s resources
    kubernetes.core.k8s:
      definition: "{{ lookup('template', '{{ item }}') | from_yaml }}"
    with_fileglob:
    - "/home/ken/k3s/argocd/01-sealed-secrets.yaml"
    - "/home/ken/k3s/argocd/02-configmap.yaml"
    - "/home/ken/k3s/argocd/[a-u]*.yaml"
    ignore_errors: true
  - name: Apply Cilium resources
    kubernetes.core.k8s:
      definition: "{{ lookup('template', '{{ item }}') | from_yaml }}"
    with_fileglob:
    - "/home/ken/k3s/cilium/[g-u]*.yaml"