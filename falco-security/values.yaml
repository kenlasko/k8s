driver:
  kind: modern-bpf
collectors:
  enabled: true
  docker:
    enabled: false
  crio:
    enabled: false
  containerd:
    enabled: true
    socket: /run/k3s/containerd/containerd.sock

customRules:
  custom-rules.yaml: |-
    - rule: Contact K8S API Server From Container
      exceptions:
      - name: allowed_to_contact_api_server
        fields: [k8s.ns.name, container.name, proc.name] 
        comps: [=,=,=]
        values:
        - [argocd, application-controller, argocd-applicat]
        - [argocd, repo-server, git]
        - [argocd, server, argocd-server]
        - [headlamp, headlamp, headlamp-server]
        - [longhorn, 24-hour-snapshots, longhorn-manage]
        - [monitoring, grafana-sc-dashboard, python]
        - [monitoring, grafana-sc-datasources, python]
        - [netdata, netdata, curl]
        - [portainer, portainer, portainer]
      append: true

    - rule: Drop and execute new binary in container
      exceptions:
      - name: allowed_to_execute_new_binary
        fields: [k8s.ns.name, container.name, proc.name] 
        comps: [=,=,=]
        values:
        - [media-tools, plex, Plex Media Scan]
        - [pihole, pihole, pihole-FTL]
      append: true

    - rule: Clear Log Activities
      exceptions:
      - name: allowed_to_clear
        fields: [container.name,proc.pname, proc.name] 
        comps: [=,=,=]
        values:
        - [host, k3s-agent, containerd]
      append: true

    - rule: Redirect STDOUT/STDIN to Network Connection in Container
      exceptions:
      - name: allowed_to_do_stdout_stdin
        fields: [k8s.ns.name, container.name, proc.name] 
        comps: [=,=,=]
        values:
        - [argocd, repo-server, argocd-repo-ser]
        - [argocd, repo-server, git]
        - [homeassist, homeassist, ping]
        - [homeassist, homeassist, python3]
        - [longhorn, longhorn-manager, longhorn]
      append: true

falcosidekick:
  enabled: true
  config:
    webhook:
      address: http://homeassist-service.homeassist.svc.cluster.local:8123/api/webhook/-H6GkrSTowPZLtenB1zerk1mY
      method: "PUT"
      minimumpriority: debug
  affinity: 
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-role.kubernetes.io/control-plane
            operator: DoesNotExist
          - key: kubernetes.io/arch
            operator: In
            values: 
            - 'amd64' 
  webui:
    enabled: true
    user: "kenadmin:U3H7zfWZkPXf*$$he"
    affinity: 
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: node-role.kubernetes.io/control-plane
              operator: DoesNotExist
            - key: kubernetes.io/arch
              operator: In
              values: 
              - 'amd64' 
    redis:
      enabled: true
      affinity: 
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: DoesNotExist
              - key: kubernetes.io/arch
                operator: In
                values: 
                - 'amd64' 
