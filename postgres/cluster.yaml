apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres
  namespace: postgres
spec:
  instances: 3
  failoverDelay: 15
  storage:
    storageClass: local-path
    size: 15Gi
  enableSuperuserAccess: true
  superuserSecret:
    name: postgres-superuser
  backup:
    barmanObjectStore:
      destinationPath: "s3://postgres@default/"
      s3Credentials:
        accessKeyId:
          name: nas-s3-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: nas-s3-creds
          key: ACCESS_KEY_SECRET
  managed:
    services:
      additional:
      - selectorType: rw
        updateStrategy: patch
        serviceTemplate:
          metadata:
            name: "postgres-service"
            labels:
              tailscale.com/proxy-class: "run-on-worker"
            annotations:
              io.cilium/lb-ipam-ips: 192.168.1.15
              tailscale.com/expose: 'true'
              tailscale.com/hostname: 'home-postgres'
          spec:
            type: LoadBalancer
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-role.kubernetes.io/control-plane
            operator: DoesNotExist
          - key: kubernetes.io/arch
            operator: In
            values: 
            - 'amd64'