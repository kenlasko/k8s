apiVersion: v1
kind: ConfigMap
metadata:
  name: plex-activity-monitor
  namespace: media-tools
data:
  plex-activity-monitor.sh: |
    #!/bin/sh
    currentDate=`date`
    echo "STARTING on $currentDate"
    # Logfile
    PLEX_LOG=/config/Library/Application\ Support/Plex\ Media\ Server/Logs/Plex\ Media\ Server.log

    # Wait 30 seconds and verify that we're looking at the right log file
    sleep 30

    if grep -Fxq "cloud provider (Metadata) is online and available" "$PLEX_LOG"
    then
        echo "Looking at current file"
    else
        cat "$PLEX_LOG"
        echo "Not looking at latest file. Exiting"
        exit 1
    fi

    tail -f "$PLEX_LOG" | while read LINE; do
      echo $LINE
      echo $LINE | grep "^.*DEBUG - Request.*GET /media/providers.*Signed-in Token.*$" && echo "ACTIVITY DETECTED" | curl -sk -X POST https://ha.ucdialplans.com/api/webhook/mediapc-power-control-urlrequest-YFZlHKL8BXgtKZpfJMfhc8G-
    done