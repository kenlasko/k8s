apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: home
  namespace: postgresql
spec:
  imageName: kenlasko/cloudnativepg-gis-vchord:16.9-vc0.4.2-1
  instances: 3
  failoverDelay: 15
  storage:
    storageClass: local-storage
    size: 15Gi
  resources:
    requests:
      cpu: 10m
      memory: 250Mi
    limits:
      memory: 1Gi
  enableSuperuserAccess: true
  superuserSecret:
    name: postgresql-superuser
  certificates:
    serverAltDNSNames:
    - "home-postgresql.tailb7050.ts.net"
    - "home-postgresql"
    - "home-postgresql.svc.cluster.local"
  # bootstrap:
  #   # If the namespace is brand-new, we restore using an existing backup object called 'clusterRestore':
  #   recovery:
  #     source: clusterRestore
    ## If the namespace still exists and there is a backup object, we can just restore using the below method:
    #   backup:
    #     name: daily-20250514170109
    ## If you want to restore to a specific point in time, use the below method:
      # recoveryTarget:
      #   targetTime: "2025-05-14 16:57:06.538776+00:00"
  externalClusters:
  - name: clusterRestore
    plugin:
      name: barman-cloud.cloudnative-pg.io
      enabled: true
      isWALArchiver: false
      parameters:
        barmanObjectName: backblaze

  postgresql:
    shared_preload_libraries:
    - "vchord.so"

  # This enables backups to S3 storage
  plugins:
  - name: barman-cloud.cloudnative-pg.io
    enabled: true
    isWALArchiver: true
    parameters:
      barmanObjectName: backblaze

  managed:
    roles:
    - name: immich
      ensure: present
      login: true
      superuser: false
      inherit: false
      connectionLimit: -1
      passwordSecret:
        name: useraccount-immich
    - name: paperless
      ensure: present
      login: true
      superuser: false
      inherit: false
      connectionLimit: -1
      passwordSecret:
        name: useraccount-paperless
    - name: prowlarr
      ensure: present
      login: true
      superuser: false
      inherit: false
      connectionLimit: -1
      passwordSecret:
        name: useraccount-prowlarr
    - name: radarr
      ensure: present
      login: true
      superuser: false
      inherit: false
      connectionLimit: -1
      passwordSecret:
        name: useraccount-radarr
    - name: sonarr
      ensure: present
      login: true
      superuser: false
      inherit: false
      connectionLimit: -1
      passwordSecret:
        name: useraccount-sonarr

    services:
      additional:
      - selectorType: rw
        updateStrategy: patch
        serviceTemplate:
          metadata:
            name: "postgresql-service"
            annotations:
              tailscale.com/expose: "true"
              tailscale.com/hostname: "home-postgresql"
              tailscale.com/proxy-class: "default"
          spec:
            type: LoadBalancer