---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: tautulli-season-fetch-script
  namespace: media
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: akeyless
    kind: ClusterSecretStore
  target:
    name: tautulli-season-fetch-script
    template:
      engineVersion: v2
      data:
        season-fetcher.py: |
          #!/usr/bin/env python
          # -*- coding: utf-8 -*-

          """Request the next season if the last (n-th) episode is watched

          Check Tautulli's Watched Percent in Tautulli > Settings > General

          1. Tautulli > Settings > Notification Agents > Script > Script Triggers:
              [âˆš] watched
          2. Tautulli > Settings > Notification Agents > Script > Gear icon:
              Enter the "Script Folder" where you save the script.
              Select "request_next_season.py" in "Script File".
              Save
          3. Tautulli > Settings > Notification Agents > Script > Script Arguments > Watched:
              <episode>{show_name} {episode_num00} {season_num00} {library_name} {themoviedb_id} {user_email}</episode>

          """
          from __future__ import print_function
          from __future__ import unicode_literals

          import requests
          import sys

          OVERSEERR_URL = 'http://seerr-service:5055'
          OVERSEERR_API_TOKEN = '{{ .seerrApiKey }}'

          # Request new season when there are less than 3 episodes left
          request_on_count_episodes_left = 3
          request_on_percent_episodes_left = 0.3 # 30% threshold
          maxNumUsers = 20

          overseerr_endpoint = f"{OVERSEERR_URL}/api/v1"
          header = {"X-Api-Key" : OVERSEERR_API_TOKEN}

          sess = requests.Session()
          # Ignore verifying the SSL certificate
          sess.verify = False  # '/path/to/certfile'
          # If verify is set to a path to a directory,
          # the directory must have been processed using the c_rehash utility supplied
          # with OpenSSL.
          if sess.verify is False:
              # Disable the warning that the request is insecure, we know that...
              import urllib3

              urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          show_name = sys.argv[1]
          next_ep_num = int(sys.argv[2])
          season_num = int(sys.argv[3])
          TV_LIBRARY = sys.argv[4]
          tmdb_id = int(sys.argv[5])
          user_email = sys.argv[6]

          # Get show info from overseerr
          tmdb_show = requests.get(f"{overseerr_endpoint}/tv/{tmdb_id}", headers=header)

          # Check if current season is less than number_of_seasons
          number_of_seasons = tmdb_show.json()["numberOfSeasons"]

          # Get number of episodes per season
          season_count = {}

          for season in tmdb_show.json()["seasons"]:
              season_count[season["seasonNumber"]] = season["episodeCount"]
              
          # Get media info - request status
          media_info = {}

          for season in tmdb_show.json()["mediaInfo"]["seasons"]:
              media_info[season["seasonNumber"]] = season["status"]
              
          requested_seasons = [1]

          for request in tmdb_show.json()["mediaInfo"]["requests"]:
              for singleRequest in request["seasons"]:
                  requested_seasons.append(singleRequest["seasonNumber"])
                  
          requested_seasons = list(dict.fromkeys(requested_seasons))
          overseerr_users = requests.get(f"{overseerr_endpoint}/user?take={maxNumUsers}", headers=header)
          requester = [user["id"] for user in overseerr_users.json()["results"] if user["email"].lower() == user_email.lower()]

          print(f"Requester: {requester}")

          def checkEpisode():
              # Check if there is another season
              if season_num == number_of_seasons:
                  
                  print(f"{show_name} - Season {season_num} is the last season. Nothing to request")
                  
                  return
              
              # Check if watcher has been added to overseerr. Otherwise default to admin account
              if len(requester) != 1:
                  print(f"{show_name} - Watcher {user_email} doesn't have valid overseerr account. Using admin account to request")
                  requester_id = 1
              else:
                  print(f"{show_name} - Watcher {user_email} has valid overseerr account.")
                  requester_id = requester[0]
              
              # Calculate the number of episodes left and the percentage left
              episodes_left = season_count[season_num] - next_ep_num
              percentage_left = episodes_left / season_count[season_num]
              
              if episodes_left <= request_on_count_episodes_left or percentage_left <= request_on_percent_episodes_left:
                  next_season = season_num + 1
                  print(f"{show_name} - Episode ({next_ep_num}) is within the last {request_on_count_episodes_left} episodes or {request_on_percent_episodes_left*100:.2f}% episodes are left in season {season_num}. Requesting season {next_season}")
                  
                  print(f"{show_name} - Media Info {media_info[next_season]}")
                  
                  print(f"{show_name} - Requested Seasons {requested_seasons}")
                  
                  if (media_info[next_season] == 1) and (next_season not in requested_seasons):
                      print(f"{show_name} - Requesting season {next_season}")
                      
                      request_data = {
                            "mediaType": "tv",
                            "mediaId": tmdb_id,
                            "seasons": [
                              next_season
                            ],
                            "userId": requester_id
                          }
                                  
                      r = requests.post(f"{overseerr_endpoint}/request", headers=header, json=request_data)
                      
                      if r.status_code == 201:
                          print(f"{show_name} - Season {next_season} requested successfully")
                      else:
                          print(f"{show_name} - Requesting season {next_season} failed: {r.json()['message']}")
                      
                  else:
                      print(f"{show_name} - Not requesting season {next_season}. Already available")
                  
              else:
                  print(f"{show_name} - Episode {next_ep_num} is not within the last {request_on_count_episodes_left} episodes and more than {request_on_percent_episodes_left*100}% of the episodes are left")
        
          checkEpisode()

  data:
  - secretKey: seerrApiKey
    remoteRef:
      key: /media-app-apikeys
      property: seerr
