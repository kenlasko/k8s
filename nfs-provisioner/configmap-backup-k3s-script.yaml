apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-k3s-script
  namespace: nfs-provisioner
data:
  backup-k3s.sh: |
    #!/bin/ash
    ######################################
    # Backup K3S etcd to NFS mount script.
    ######################################  
    echo 'Backing up K3S etcd'
    cp -p `ls -t /data/* | head -2` /backup/

    echo 'Deleting old K3S etcd backups'
    COUNT=$(find /backup -type f -mtime -14 | wc -l)
    if [ $COUNT -gt 12 ]
    then
      find /backup/* -mtime +14 -exec rm {} \;
    fi